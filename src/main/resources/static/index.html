<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>首页</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="css/bootstrap.css"/>
    <link rel="stylesheet" type="text/css" href="css/pb.css"/>
    <style>
        body {
            margin: 30px;
        }

        #result {
            font-size: 15px;
            padding: 10px;
        }
    </style>
</head>
<body>

<div class="form-group">
    <label>付款方公钥</label>
    <textarea type="text" class="form-control" id="senderPublickey">MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtF3uNaTIcHyQgcVSyB1OAQrDzBW/1wgu
bAgwF5bG2Ru+qINSmt76B8m4qWkGNDrT4x8ZjSwtuxU9JnnUkBZDb0DE6+vqJmNg6kH+E1LYn+/0
+PRGeLrSwOYxKO+jNUI3gQ8bllnIYQQCBKt8sveilEziETLyBmPecusb2C19gvXh9IhT3llGmG7z
sJvBBcWPdLeaNu7Szy7huOXV75T0U7UscHIznVg/cknC20cv0fBZ05omD0N/hXJ12pWPQ3JCS2wx
EPe+AV+FwWDQDwn05drdbt/aohmIaa1cO2op08v/5xKB9Bb7N4YPDEsDeQD8MU4PJ/5cNk2d1RP+
WwSFjwIDAQAB</textarea>
</div>
<div class="form-group">
    <label>付款方私钥</label>
    <textarea type="text" class="form-control" id="senderPrivatekey">-----BEGIN PRIVATE KEY-----
MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQC0Xe41pMhwfJCBxVLIHU4BCsPM
Fb/XCC5sCDAXlsbZG76og1Ka3voHybipaQY0OtPjHxmNLC27FT0medSQFkNvQMTr6+omY2DqQf4T
Utif7/T49EZ4utLA5jEo76M1QjeBDxuWWchhBAIEq3yy96KUTOIRMvIGY95y6xvYLX2C9eH0iFPe
WUaYbvOwm8EFxY90t5o27tLPLuG45dXvlPRTtSxwcjOdWD9yScLbRy/R8FnTmiYPQ3+FcnXalY9D
ckJLbDEQ974BX4XBYNAPCfTl2t1u39qiGYhprVw7ainTy//nEoH0Fvs3hg8MSwN5APwxTg8n/lw2
TZ3VE/5bBIWPAgMBAAECggEBAIQy8Jzq6WrhMf2bxoAcUoca/8W/Dzwpp/TQz4cKoTaSSl0y28Hd
ur8okCvDaaOwlos6yTya6+3atFZWJ4Fwf/60J2GQKa/3WRp6QiKhr1sSwqgSSvDEZiKy1cdeVW58
2TfD/gFmTyMkj+IiWyTFsqkl7PCUOaaLXok2X9NEDGGGYFjqdONfnEedJOnWM6ZF4p6r/U8vBMJk
5g0QuMNqbKEBE6WMXb2cfz7vlE/Y7DhRCk8C7D7ryo0kS9qfoxMQ6yz62Oo4DPb7JDhf907IrXFb
PZtJDfYvppSl1+rq8wy7QALGZ6dQMHhKadrnpYlPZYOHqVhLTmZb1U9wpjjPFhkCgYEA7rNgrWSP
eG/34ViPX3XFVTSR2boE5IB8MSdmyHwMcW61rPFym1XODo54VRztFt3zFa6qBObOOOLAGbjCp7dz
FVAHh0n+cwWWp5B8tg6lcbS5yby6cr6M7N59bvckKZovhGDRpyKgdSGkwGhxflZx8l/EwlCqDOM0
oakxzUSUK4UCgYEAwXBIw2DT7YKQAAAFceUM+eUAAOdv4atJzyTBZlXIhIn+dI/jKoDtEEru43gB
35oEJgRDDeoLdQzP6WUW6khOuMTEKYCetRJDgLWwbyw6N34E0gYMpjMRESGLbi/ymF8uqPPXLiEv
4LXNK/hks5jruUUGRr/zbsv5OoeistHn5wMCgYEA6mCbRuX8scdPX6czcAoVruolY+HxN+SpDSKh
G64iEachICUb4UZJQ6XEpd33NoLMUrfkHVf7mYOcGCWAjGnmyECCg+a1v373RKTsr16GOLW5z0pO
0Kgle9ei1jg4+9h3W8YtVaz8XMaiHILxHZoH3HMIobvOnUTiwvF9Aw6ZZnkCgYB+arFC7m7SE7ek
KF9mlbirP9uGu7nEk7rC41R5WqqW49AlwTtGtcc4FKCWjAE9blwztClWWJRwRJVEBMq7BdJcsks4
jFQsJelznknV/eN2DKd90nJF063dsjx7IF688cd+pw0DmrC9fFK/36+AJ/o1tERrzFp9GFSiya2s
i72wnQKBgGKT9g08IykMOC703KZ2hEUWGrlsPbts3UZUHz5Hvj06KQhLjTlsR6ZFgExZVffTADbp
43+RsNAMLOohMw+B/Cn0Bx8tr9en6HO+bKp/FpzajYXbJlT7WY1ZmRTcNN48bw5s8pzKJR9SxaOk
wGIGEkdEqPEa7HXgdoc4hYub1O2J
-----END PRIVATE KEY-----</textarea>
</div>
<div class="form-group">
    <label>收款方公钥</label>
    <textarea type="text" class="form-control" id="receiverPublickey">MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAhv7EhVY8Kn8brHXuwsfMWIX/2z3LLyUU
74Iq4uEoC5cu2ZAC5Tj3DkEX6Q83Pw6kbITqFEQzVuXx4VvRqi9J/mGgEpWaG++OEgHa1UIHnClY
CfGg4KW8XKMWtnPbnXgpzo6t+CDopcoFR9JDB0P47fgBR4+xByibVDG271DG6EfY+ASDcPHJ82cJ
uO8mwLUIrS0ISOQjV6Sy6KMoWtQ+TwX18ROVIMHQ0f2TbBOEzYw+m6tKUUTtcMLVxo6XvG8XSbgi
rlXYujqDlmpRA+sl5FrzHe45gBQw1xh9Tj7C9ayPI4k2yBamjz7eXW7A/Fq0wWovpv9t28X/N/hZ
hsAUnQIDAQAB</textarea>
</div>

<div class="form-group">
    <input type="text" class="form-control" id="inputContent" placeholder="请输入交易金额">
</div>

<div class="form-group">
    <input type="text" class="form-control" id="inputNode" placeholder="请输入想连接的节点连接">
</div>

<div class="btn-group btn-group-lg">
    <button type="button" class="btn btn-default" onclick="addFirstBlock()">添加创世区块</button>
    <button type="button" class="btn btn-default" onclick="addBlock()">添加普通区块</button>
    <button type="button" class="btn btn-default" onclick="clickShowData()">展示数据</button>
    <button type="button" class="btn btn-default" onclick="verify()">校验数据</button>
</div>

<div class="btn-group btn-group-lg">
    <button type="button" class="btn btn-default" onclick="regist()">注册节点</button>
    <button type="button" class="btn btn-default" onclick="conn()">连接</button>
    <button type="button" class="btn btn-default" onclick="syncData()">同步</button>
</div>

<p id="result"></p>

<table class="table">

    <thead>
    <tr>

        <th>ID</th>
        <th>内容</th>
        <th>哈希值</th>
        <th>工作量证明</th>
        <th>preHash</th>
    </tr>
    </thead>
    <tbody id="tagTbody">

    </tbody>
</table>

<script src="js/jquery-1.12.4.min.js" type="text/javascript" charset="utf-8"></script>
<script src="js/bootstrap.js" type="text/javascript" charset="utf-8"></script>
<script src="js/pb.js" type="text/javascript" charset="utf-8"></script>
<script src="js/jsrsasign-all-min.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript">
    function addFirstBlock() {
        showDialog()
        var content = $("#inputContent").val()
        if (content == "") {
            $("#result").attr("class", "bg-warning")
            $("#result").html("交易内容不能为空!!!")
        } else {
            $.post("addFirstBlock", {start: content}, function (data) {
                if (data.indexOf("创建失败") > 0) {
                    $("#result").attr("class", "bg-success")
                } else {
                    $("#result").attr("class", "bg-danger")
                }
                $("#result").html(data)
            })
            clearInput()
            showBlockChainData()
        }
        hiddenDialog()
    }

    function addBlock() {
        //获取输入的金额
        var content = $("#inputContent").val()
        // 发送方的私钥
        var senderPrivatekey = $("#senderPrivatekey").val();
        // 发送方的公钥
        var senderPublickey = $("#senderPublickey").val();
        // 接收方的公钥
        var receiverPublickey = $("#receiverPublickey").val();
        // 生成私钥
        var prvKey = KEYUTIL.getKey(senderPrivatekey);
        // 指定算法
        var sig = new KJUR.crypto.Signature({"alg": "SHA256withRSA"});
        // 初始化
        sig.init(prvKey);
        // 指定原文
        sig.updateString(content)
        // 生成签名
        var sigValueHex = sig.sign()

        if (content == "") {
            $("#result").attr("class", "bg-warning")
            $("#result").html("交易金额不能为空!!!")
        } else {
            $.post("addBlock",
                {
                    sendAddr: senderPublickey,
                    receiveAddr: receiverPublickey,
                    content: content,
                    sign: sigValueHex,
                }, function (data) {
                    if (data.indexOf("创建失败") > 0) {
                        $("#result").attr("class", "bg-danger")
                    } else {
                        $("#result").attr("class", "bg-success")
                    }
                    $("#result").html(data)
                })
            clearInput()
            showBlockChainData()
        }
    }

    function clickShowData() {
        showBlockChainData()
        $("#result").attr("class", "bg-info")
        $("#result").html("查询到下列数据")
    }

    function showBlockChainData() {
        showDialog()
        $("#tagTbody").html("")
        $.get("showBlockChainData", function (data) {
            for (var i = 0; i < data.length; i++) {
                var id = data[i].id;
                var content = data[i].content;
                var hash = data[i].hash;
                var proof = data[i].proof;
                var preHash = data[i].preHash;
                $("#tagTbody").append("<tr><td>" + id + "</td><td>" + content + "</td><td>" + hash + "</td><td>" + proof + "</td><td>" + preHash + "</td></tr>")
            }
            hiddenDialog()
        })
    }

    function verify() {
        showBlockChainData()
        $.get("verify", function (data) {
            if (data == "未检测到区块数据被篡改") {
                $("#result").attr("class", "bg-success")
            } else {
                $("#result").attr("class", "bg-danger")
            }
            $("#result").html(data)
        })
    }

    function regist() {
        showDialog() // 显示进度条
        // 1.获取输入的内容
        var node = $("#inputNode").val();
        // 2. 发起请求
        $.post("regist", // 请求路径
            "port=" + node,// 传递的数据
            function (data) { // 请求成功的回调函数
                // 展示操作结果
                $("#result").html(data)
                // 清空输入框
                $("#inputNode").val("");
                hiddenDialog() // 隐藏进度条
            });
    }

    function conn() {
        showDialog() // 显示进度条
        $.post("conn", // 请求路径
            function (data) { // 请求成功的回调函数
                // 展示操作结果
                $("#result").html(data)
                hiddenDialog() // 隐藏进度条
            });
    }

    function syncData() {
        showDialog() // 显示进度条
        // 2. 发起请求
        $.post("syncData", // 请求路径
            function (data) { // 请求成功的回调函数
                // 展示操作结果
                $("#result").html(data)
                hiddenDialog() // 隐藏进度条
            });
    }

    function clearInput() {
        $("#inputContent").val("")
    }

    // 显示进度条
    function showDialog() {
        loading.baosight.showPageLoadingMsg(false)
    }

    // 隐藏进度条
    function hiddenDialog() {
        loading.baosight.hidePageLoadingMsg()
    }

    $(function () {
        showBlockChainData()
    })

</script>

</body>
</html>